@model ICollection<CQA.Models.EvaluatedAnswers>

@section Styles{
    @Styles.Render("~/Content/themes/base/css")
}

@{
    ViewBag.Title = "Ohodnotené odpovede";
}


@if(!Model.Any()){
    <h4>Ľutujeme, zatiaľ pre Vás nie sú k dispozícii žiadne ohodnotené odpovede.</h4>
}
else{
    <h3>Vaše ohodnotené odpovede</h3>
    foreach (var ea in Model)
    {
        <div class="setup" >@Html.Raw("<span style=\"font-size: 24px\">" + ea.Setup.Subject.Name + " " + ea.Setup.Name + " </span><br/>" +
            "Počet nových ohodnotených odpovedí:" + "<b>" + ea.UnseenCount +
            " </b> | "+
            "Počet všetkých ohodnotených odpovedí: " + "<b>" + ea.Answers.Count() + "</b>" )
        </div>
        
        <div class="header">
            <div class="header_value">
                Hodnotenie
            </div>
            <div class="header_qa">Otázka</div>
            <div class="header_qa">Odpoveď</div>

            <div style="clear:both"></div>
        </div>
    
        {
            int i = 0;
            foreach (var a in ea.Answers)
            {
                i++;
            
                <div class="myAnswer
                    @if (i % 2 == 0)
                        {@(" greyBackground")}
                    @if (ea.UnseenHighlightedAnswers.Contains(a))
                       {@(" empAnswer")}" 
                    @if (i == 1)
                       {@Html.Raw("style=\"border-top: 1px solid lightgrey;\"")} >
                    
                    <div class="evalValueWrap" style="background: white">
                    <div class="evalValue">
                        <div class="evalValueBg">
                            <div class="cleanValue"></div>
                           
                            @{
                                int n =  a.Evaluations.Count(); 
                                <div class="evalsCount">@(n) 
                                    @if(n == 1){
                                        @("hodnotenie");
                                    }
                                    else if( n < 5){
                                         @("hodnotenia");
                                    }
                                    else{
                                         @("hodnotení");
                                    }
                                 </div>
                            }
                            
                        </div>
                    </div>
                    </div>
                    
                    
                    <div class="elipsis">@(a.Question.QuestionText)</div>
                    <div class="elipsis" style="border-left: 1px solid lightgrey;">@(a.Text)</div>
                    @{
                        string s = "";
                        foreach(var e in a.Evaluations){
                            s += e.Value.ToString() + ";";
                        }
                        s = s.Substring(0,s.Length-1);
                    }
                    <input type="hidden" value="@(s)" name="evaluations" class="evaluations" />
                    <input type="hidden" value="@(a.Question.QuestionText)" name="que" class="que" />
                    <input type="hidden" value="@((int)(a.GetAvgEvaluation() * 100))" name="numValue" class="numValue" />
                        <input type="hidden" value="@(a.Text)" name="ans" class="ans" />
                    <input type="hidden" value="@(a.Evaluations.Count())" name="count" class="count" />
                    <div class="detail btn" title="Zobraziť detail">
                        ››
                    </div>
                    <div style="clear:both"></div>
                     <div style="display: none" id="commentsWrap">
                        <div id="comments" style="margin-left:10px; margin-top: 5px; width: 100%; border-top: 1px solid #cccccc; max-height: 150px; overflow: auto; ">
                            <h5 style="margin:0;margin-top:5px; margin-bottom:5px">Komentáre:</h5>
                            @if(a.Comments.Any()){
                                foreach(CQA.Models.Comment c in a.Comments)
                                {
                                    
                                    <div class="comment">
                                        <b>
                                        @if(c.Anonymous){
                                           @("Anonym:") 
                                        }
                                        else{
                                            @(c.Author.RealName+":")
                                        } 
                                        </b> 
                                        @(c.Text)
                                    </div>
                                }
                            }
                            else
                            {
                                @("K odpovedi neboli zatiaľ vytvorené žiadne komentáre")
                            } 
                        </div>
                    </div>
                     
                 </div>
            }
        }
    
        <div id="dialog" title="Detail odpovede">
            <div class="dialogQaText" id="que"></div>
            <div class="dialogQaText" id="ans"> </div>
            <div class="sliderWrap">
                <div id="textValue"> </div>
                <div class="ui-widget-content-wrapper" id="sliderContent" style="width: 100%; margin-top: 25px;">
                    <div class="slider-range" ></div>
                </div> 
            </div>
            <div style="clear: both"></div>
            <div style="text-align: center; width: 100%"> Počet hodnotení odpovede: <b id="evalsCount">12</b></div>
            <div id="commentsDialogWrap"></div>
        
        </div>
    }
}

@section Scripts{
     @Scripts.Render("~/Scripts/jquery.dotdotdot.min.js")
     @Scripts.Render("~/bundles/jqueryui")
<script type="text/javascript">

    $(document).ready(function () {

        $(".elipsis").dotdotdot();
        
        $(".slider-range").slider({
            range: false,
            min: 0,
            max: 100,
            value: 50,
        });
        $(".slider-range").slider('disable');

        $("#dialog").dialog({
            autoOpen: false,
            resizable: true,
            modal: true,
            width: 'auto',
            height: 'auto',
            draggable: false
        })

        $('body').on("click",'.ui-widget-overlay', function () {
            $("#dialog").dialog("close");
        });
       

        $(".myAnswer").click(function () {
            var val = $(this).children(".numValue").val();
            var que = $(this).children(".que").val();
            var ans = $(this).children(".ans").val();
            var count = $(this).children(".count").val();

            SetDialogValues(ans, que, count, val);
            var arr = $(this).children(".evaluations").val().split(';');
            $("#sliderContent").children(".crowdSlider").remove()
            $.each(arr, function (index, item) {
                var x = parseInt(item.replace(/\s/g, "").replace(",", ".") * 100)
                if(x >= 50)
                    $("#sliderContent").prepend('<div class="crowdSlider" style="left:' + x + '%; margin-left: -14px; "></div>');
                else
                    $("#sliderContent").prepend('<div class="crowdSlider" style="left:' + x + '%; margin-left: -8px; "></div>');
            });

            $(this).removeClass('empAnswer');
            $("#dialog").children("#commentsDialogWrap").html($(this).children("#commentsWrap").html())
            
        });

        function SetDialogValues(ans, que, count, val) {
            val = parseFloat(val.replace(/\s/g, "").replace(",", "."));
            $(".slider-range").slider('value', val);
            $("#que").html("<b>Otázka: </b>");
            $("#que").append(que);
            $("#ans").text(ans);
            $("#ans").prepend("<b>Odpoveď: </b>");
            $("#evalsCount").text(count);

            setSlider(val)
            
        }

        function setSlider(val) {
            if (val > 50) {
                //$(".ui-widget-content-wrapper").css("background", "rgba(22, 149, 49, " + (val - 50) * 2 / 100 + ")");
                $(".ui-widget-content-wrapper").css("background", getColor(val));
            }
            else {
                $(".ui-widget-content-wrapper").css("background", getColor(val));
            }

            var el = $("#textValue");
            changeText(el, val);
            $("#dialog").dialog("open");
            
        }
        

        function changeText(el, val) {
            if (val < 10)
                el.html("Silný nesúhlas")
            else if (val < 26) {
                el.html("Nesúhlas")
                el.addClass("evalValueOneRow")
            }
            else if (val < 42)
                el.html("Skôr nesúhlas")
            else if (val < 58) {
                el.html("Čiastočný súhlas")
            }
            else if (val < 74) {
                el.html("Skôr súhlas")
                el.addClass("evalValueOneRow")
            }
            else if (val < 90) {
                el.html("Súhlas")
                el.addClass("evalValueOneRow")
            }
            else
                el.html("Silný súhlas")
        }

        $(".evalValueBg").each(function () {
            var val = parseFloat($(this).parent().parent().siblings(".numValue").val().replace(/\s/g, "").replace(",", "."));
            $(this).parent().css("background", getColorWithOpacity(val, $(this).parent().parent().siblings(".count").val()));
        });

        $(".cleanValue").each(function () {
            changeText($(this), parseFloat($(this).parent().parent().parent().siblings(".numValue").val().replace(/\s/g, "").replace(",", ".")));
        });

        function getColorWithOpacity(val, evalsCount)
        {
            if(evalsCount < 10)
                opacity = 10-evalsCount;
            else
                opacity = 1;
            if(val > 50)
                return "rgba(" + (220 - ((val - 50) * 4)) + ", 180, 20, " + (0.2 + (0.8/opacity)) + ")"
            else
                return "rgba( 220, " + (180 - Math.ceil((50 - val) * 3.5)) + ", 20, " + (0.2 + (0.8 / opacity)) + ")"
        }

        function getColor(val) {
            if (val > 50) {
                return "rgb(" + (220 - ((val - 50) * 4)) + ", 180, 20)"
            }
            else {
                return "rgb( 220, " + Math.ceil(180 - ((50 - val) * 3.5)) + ", 20)"
            }
        }
     
    });
    </script>
    }
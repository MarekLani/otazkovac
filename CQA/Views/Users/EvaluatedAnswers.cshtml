@model ICollection<CQA.Models.EvaluatedAnswers>

@section Styles{
    @Styles.Render("~/Content/themes/base/css")
}

@{
    ViewBag.Title = "Ohodnotené odpovede";
}


@if(!Model.Any()){
    <h4>Ľutujeme, zatiaľ pre Vás nie sú k dispozícii žiadne ohodnotené odpovede.</h4>
}
else{
    <h3>Vaše ohodnotené odpovede</h3>
    foreach (var ea in Model)
    {
        <div class="setup" >@Html.Raw("<span style=\"font-size: 24px\">" + ea.Setup.Subject.Name + " " + ea.Setup.Name + " </span><br/>" +
            "Počet nových ohodnotených odpovedí:" + "<b>" + ea.UnseenCount +
            " </b> | "+
            "Počet všetkých ohodnotených odpovedí: " + "<b>" + ea.Answers.Count() + "</b>" )
        </div>
        
        <div class="header">
            <div class="header_value">
                Hodnotenie
            </div>
            <div class="header_qa">Otázka</div>
            <div class="header_qa">Odpoveď</div>

            <div style="clear:both"></div>
        </div>
    
        {
            int i = 0;
            foreach (var a in ea.Answers)
            {
                i++;
            
                <div class="myAnswer 
                    @if (i % 2 == 0)
                        {@(" greyBackground")}
                    @if (ea.UnseenHighlightedAnswers.Contains(a))
                       {@(" empAnswer")}" 
                    @if (i == 1)
                       {@Html.Raw("style=\"border-top: 1px solid lightgrey;\"")} >
                    <div class="evalValue">
                        <div class="evalValueBg">
                            <div class="cleanValue"></div>
                           
                            @{
                                int n =  a.Evaluations.Count(); 
                                <div style="font-size: 11px; line-height: 13px">@(n) 
                                    @if(n == 1){
                                        @("hodnotenie");
                                    }
                                    else if( n < 5){
                                         @("hodnotenie");
                                    }
                                    else{
                                         @("hodnotení");
                                    }
                                 </div>
                            }
                            
                        </div>
                    </div>
                    
                    <div class="elipsis">@(a.Question.QuestionText)</div>
                    <div class="elipsis" style="border-left: 1px solid lightgrey;">@(a.Text)</div>
                    <input type="hidden" value="@(a.Question.QuestionText)" name="que" class="que" />
                    <input type="hidden" value="@((int)(a.GetAvgEvaluation() * 100))" name="numValue" class="numValue" />
                     <input type="hidden" value="@(a.Text)" name="ans" class="ans" />
                    <input type="hidden" value="@(a.Evaluations.Count())" name="count" class="count" />
                    <div class="detail btn" title="Zobraziť detail">
                        ››
                    </div>
                    <div style="clear:both"></div>
                 </div>
            }
        }
    
        <div id="dialog" title="Detail odpovede">
            <div class="dialogQaText" id="que"></div>
            <div class="dialogQaText" id="ans"> </div>
            <div class="sliderWrap">
                <div id="textValue"> </div>
                <div class="ui-widget-content-wrapper" style="width: 100%; margin-top: 25px;">
                    <div class="slider-range" ></div>
                </div> 
            </div>
            <div style="clear: both"></div>
            <div style="text-align: center; width: 100%"> Počet hodnotení odpovede: <b id="evalsCount">12</b></div>
        
        </div>
    }
}

@section Scripts{
     @Scripts.Render("~/Scripts/jquery.dotdotdot.min.js")
     @Scripts.Render("~/bundles/jqueryui")
<script type="text/javascript">

    $(document).ready(function () {

        $(".elipsis").dotdotdot();
        
        $(".slider-range").slider({
            range: false,
            min: 0,
            max: 100,
            value: 50,
        });
        $(".slider-range").slider('disable');

        $("#dialog").dialog({
            autoOpen: false,
            resizable: true,
            modal: true,
            width: 'auto'
        });

        $(".detail").click(function () {
            var val = $(this).siblings(".numValue").val();
            val = parseFloat(val.replace(/\s/g, "").replace(",", "."));
            $(".slider-range").slider('value', val);
            $("#que").html("<b>Otázka: </b>");
            $("#que").append($(this).siblings(".que").val());
            $("#ans").text($(this).siblings(".ans").val());
            $("#ans").prepend("<b>Odpoveď: </b>");
            $("#evalsCount").text($(this).siblings(".count").val());
            setSlider(val)
            $(this).parent().removeClass('empAnswer');
        });

        $(".myAnswer").click(function () {
            var val = $(this).children(".numValue").val();
            val = parseFloat(val.replace(/\s/g, "").replace(",", "."));
            $(".slider-range").slider('value', val);
            $("#que").html("<b>Otázka: </b>"); 
            $("#que").append($(this).children(".que").val());
            $("#ans").text($(this).children(".ans").val());
            $("#ans").prepend("<b>Odpoveď: </b>");
            $("#evalsCount").text($(this).children(".count").val());
            setSlider(val)
            $(this).removeClass('empAnswer');
            
        });

        function setSlider(val) {
            if (val > 50) {
                //$(".ui-widget-content-wrapper").css("background", "rgba(22, 149, 49, " + (val - 50) * 2 / 100 + ")");
                $(".ui-widget-content-wrapper").css("background", getColor(val));
            }
            else {
                $(".ui-widget-content-wrapper").css("background", getColor(val));
            }

            var el = $("#textValue");
            changeText(el, val);
            $("#dialog").dialog("open");
        }
        

        function changeText(el, val) {
            if (val < 10)
                el.html("Silný nesúhlas")
            else if (val < 26)
                el.html("Nesúhlas")
            else if (val < 42)
                el.html("Skôr nesúhlas")
            else if (val < 58)
                el.html("Čiastočný súhlas")
            else if (val < 74)
                el.html("Skôr súhlas")
            else if (val < 90)
                el.html("Súhlas")
            else
                el.html("Silný súhlas")
        }

        $(".evalValueBg").each(function () {
            var val = parseFloat($(this).parent().siblings(".numValue").val().replace(/\s/g, "").replace(",", "."));
            $(this).parent().css("background", getColorWithOpacity(val, 2));
        });

        $(".cleanValue").each(function () {
            changeText($(this), parseFloat($(this).parent().parent().siblings(".numValue").val().replace(/\s/g, "").replace(",", ".")));
        });

        function getColorWithOpacity(val, evalsCount)
        {
            if(evalsCount < 10)
                opacity = 10-evalsCount;
            else
                opacity = 1;
            if(val > 50)
                return "rgba(" + (220 - ((val - 50) * 4)) + ", 180, 20, " + (0.6 + (0.4/opacity)) + ")"
            else
                return "rgba( 220, " + (180 - ((50 - val) * 3.5)) + ", 20, " + (0.6 + (0.4 / opacity)) + ")"
        }

        function getColor(val) {
            if (val > 50)
                return "rgb(" + (220 - ((val - 50) * 4)) + ", 180, 20)"
            else
                return "rgb( 220, " + (180 - ((50 - val) * 3.5)) + ", 20)"
        }
     
    });
    </script>
    }
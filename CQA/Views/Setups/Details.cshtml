@model CQA.Models.Setup

@{
    ViewBag.Title = "Details";
}

@section Styles {
    @Styles.Render("~/Content/themes/base/css")
}

<h2>Details</h2>

Koncepty:
<div id="concepts">
@{
    <div id="conceptsList">
        @foreach (var concept in Model.Subject.Concepts){
            <div>
                <span class="existingConcept" >@(concept.Value)</span>
                <input type="hidden" class="conceptId" value="@concept.ConceptId" />
                <span style="margin-left:10px; cursor:pointer;" class="deleteConcept">x</span>
            </div>
        }
    </div>
    <div style="clear:both"></div>
}
</div>
Pridať koncept:
@using (Ajax.BeginForm(null, null, new AjaxOptions()
{
    HttpMethod = "POST",
    Url = Url.Action("AddConcept", "Subjects"),
    OnSuccess = "AddConcept(data)"
},
new { autocomplete = "off" }))
{
    <input name="SubjectId" type="hidden" value="@Html.DisplayFor(model => model.SubjectId)"/>
    <input id="newConcept" name="Value" />
    <button id="addConcept" type="submit" class="btn btn-default">Pridať koncept</button>
}

<hr />
<p>Začiatok semestra:</p>
@using (Ajax.BeginForm(null, null, new AjaxOptions()
{
    HttpMethod = "POST",
    Url = Url.Action("SetStartDate", "Setups"),
},
new { autocomplete = "off" }))
{
    <input type="text" name="date" value="@Html.DisplayFor(model => model.StartDate)" id="datepicker">
    <input name="setupId" type="hidden" value="@Html.DisplayFor(model => model.SetupId)"/>
    <button type="submit" class="btn" style="position:relative; top: -6px">Nastaviť</button>
}
<hr />
<table id="conceptWeeks">
    @{
        <tr>
            <td></td>
            @for (int i = 0; i < 13; i++)
            {
                <td style="text-align:center">@i</td>
            }
        </tr>
        foreach (var concept in Model.Subject.Concepts)
        {
            <tr class="concept" id="@("c"+concept.ConceptId)">
                <td class="conceptValue">@(concept.Value) (@concept.Questions.Count())</td>
                
                @for (int i = 0; i < 13; i++)
                {
                    
                    string style = "";
                    if (Model.StartDate.AddDays(7 * i) <= DateTime.Now && Model.StartDate.AddDays(7 * i +6) >= DateTime.Now)
                    {
                        style = "style=\"background: green;\"";
                    }
                    <td @Html.Raw(style)>        
                    @if (concept.ActiveWeeksList.Contains(i))
                    {
                        <input type="checkbox" class="activeCheckbox"  checked data-week="@i" data-conceptId="@concept.ConceptId" />
                    }
                    else
                    {
                        <input type="checkbox" class="activeCheckbox" data-week="@i" data-conceptId="@concept.ConceptId" />
                    }
                    </td>
                }
                <td>
                @using (Ajax.BeginForm(null, null, new AjaxOptions()
                {
                    HttpMethod = "POST",
                    Url = Url.Action("RemoveConcept", "Subjects"),
                },
                new { autocomplete = "off", style = "margin:0; padding: 0;" }))
                {
                    
                        <input name="conceptId" type="hidden" value="@concept.ConceptId"/>
                        <button type="submit" class="removeConcept"> X </button>
                    
                }
                    </td>
          </tr>
        }
    }
    <tr>
        <td></td>
     @for (int i = 0; i < 13; i++)
     {
         List<CQA.Models.Question> questions = new List<CQA.Models.Question>();
         foreach (var concept in Model.Subject.Concepts)
         {

             if (concept.ActiveWeeksList.Contains(i))
             {
                 foreach (var q in concept.Questions)
                 {
                     if (!questions.Contains(q))
                     {
                         questions.Add(q);
                     }
                 }
             }
         }
         <td id="weekTotal@(i)">@questions.Count()</td>;
     }
     </tr>
</table>
<hr />

 
<!--
<fieldset>
    <legend>Setup</legend>

    <div class="display-label">
         @Html.DisplayNameFor(model => model.Name)
    </div>
    <div class="display-field">
        @Html.DisplayFor(model => model.Name)
    </div>

    <div class="display-label">
         @Html.DisplayNameFor(model => model.Active)
    </div>
    <div class="display-field">
        @Html.DisplayFor(model => model.Active)
    </div>

    <div class="display-label">
         @Html.DisplayNameFor(model => model.Subject.Name)
    </div>
    <div class="display-field">
        @Html.DisplayFor(model => model.Subject.Name)
    </div>
</fieldset> -->
<p>
    @Html.ActionLink("Stats", "GetBasicStatistics") |
    @Html.ActionLink("Edit", "Edit", new { id = Model.SetupId }) |
    @Html.ActionLink("Back to List", "Index")
</p>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryui")
    @Scripts.Render("~/bundles/jqueryval")
    <script>
        
        function AddConcept(data){
            var concept = $("#newConcept").val()
            $("#newConcept").val("")
            if(concept != "")
                $("#conceptsList").append('<div class="existingConcept">' + concept + '</div>')
            $("#conceptWeeks").append(data["conceptWeeks"]);


        }
       $(document).ready(function (){
 

           $(document).on("click", ".activeCheckbox", function (e) {
               if ($(e.target).is(":checked"))
                   activateConcept($(e.target).attr("data-conceptId"), $(e.target).attr("data-week"));
               else
                   deactivateConcept($(e.target).attr("data-conceptId"), $(e.target).attr("data-week"));
           });

           $(document).on("click", ".removeConcept", function (e) {
               $(e.target).parent().submit();
               $(e.target).parent().parent().parent().remove();
                  
           });

           $(document).on("click", ".deleteConcept", function (e) {
               var id = $(e.target).sibling(".conceptId").val();
               $(e.target).parent().remove();
               $("#c"+id).remove();
               
               $.ajax({
                   url: "@Url.Action("DeleteConcept", "Subjects")",
                   method: "post",
                   contentType: "json",
                   data: '{"ConceptId":' + conceptId+'}'
               });
           });

           function activateConcept(conceptId, week) {
               $.ajax({
                   url: "@Url.Action("ActivateConcept", "Subjects")",
                   method: "post",
                   contentType: "json",
                   data: '{"ConceptId":' + conceptId + ', "ActiveWeeks":"' + week + '"}',
                   success: refresh
               })
           }

           function deactivateConcept(conceptId, week) {
               $.ajax({
                   url: "@Url.Action("DeactivateConcept", "Subjects")",
                   method: "post",
                   contentType: "json",
                   data: '{"ConceptId":' + conceptId + ', "ActiveWeeks":"' + week + '"}',
                   success: refresh
               })
           }

           function refresh(res) {
               $("#weekTotal" + res["week"]).html(res["weekQuestionsCount"]);
           }

            $(function () {
                $("#datepicker").datepicker();
            });
        });
    </script>
}
